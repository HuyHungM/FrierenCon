const socket = io();

$(document).ready(function () {
  // Auto scroll xuống cuối khi load
  const scrollMessageList = setInterval(function () {
    const messageList = $(".message-list");
    if (messageList.length > 0) {
      messageList.animate(
        { scrollTop: messageList[0].scrollHeight },
        1000,
        function () {
          clearInterval(scrollMessageList);
        }
      );
    }
  }, 1000);

  // Tự động resize textarea
  $("#message-input").on("input", function () {
    let $this = $(this);
    $this.css("height", "auto");
    let newHeight = $this[0].scrollHeight;
    $this.css("height", Math.min(newHeight, 140) + "px");
  });

  // Enter để gửi, Shift+Enter để xuống dòng
  $("#message-input").on("keydown", function (event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      $("#message-form").submit();
    }
  });

  // Gửi tin nhắn
  $("#message-form").on("submit", function (e) {
    e.preventDefault();
    if (!isWaifu) return;

    const message = $("#message-input")
      .val()
      .trim()
      .replace(/:heart:/g, "♥");

    if (message === "") return;

    socket.emit("sendWaifuMessage", { userId, userName, message });
    $("#message-input").val("").css("height", "auto");

    // Hiện tin nhắn user ngay
    const userMessageContainer = $("<div>")
      .addClass("message-container user")
      .append($("<div>").addClass("message").text(message));

    $("#dashboard .message-list").append(userMessageContainer);
    $(".message-list").animate({
      scrollTop: $(".message-list")[0].scrollHeight,
    });

    // Thêm dot loading
    setTimeout(function () {
      const dotLoadingContainer = $("<div>").addClass("dot-loading");
      for (let i = 0; i < 3; i++) {
        dotLoadingContainer.append($("<span>").css("--delay", `${i * 100}ms`));
      }
      $("#dashboard .message-list").append(dotLoadingContainer);
      $(".message-list").animate({
        scrollTop: $(".message-list")[0].scrollHeight,
      });
    }, 500);
  });

  socket.on(`sendWaifuMessage-${userId}`, function (res) {
    $("#dashboard .message-list .dot-loading").remove();
    console.log(res);
    setTimeout(function () {
      const replyText =
        typeof res === "string" && res.trim() !== ""
          ? res
          : "Em bị lag rồi, nói lại nha ❤️";

      const waifuMessageContainer = $("<div>")
        .addClass("message-container waifu")
        .append($("<div>").addClass("message").text(replyText));

      $("#dashboard .message-list").append(waifuMessageContainer);
      $(".message-list").animate({
        scrollTop: $(".message-list")[0].scrollHeight,
      });
    }, 500);
  });
});
